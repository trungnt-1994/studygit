From 027ea88f38a6851e42e2f95d958bf3723bba5282 Mon Sep 17 00:00:00 2001
From: longnvcmc <longnvcmc>
Date: Thu, 1 Feb 2018 08:53:32 +0000
Subject: [PATCH] test

---
 bonnie++-1.97.3/debian/tests/bonnie++_script  | 59 +++++++++++++++++++++++++++
 bonnie++-1.97.3/debian/tests/control          |  8 +++-
 bonnie++-1.97.3/debian/tests/getc_putc_script | 36 ++++++++++++++++
 bonnie++-1.97.3/debian/tests/smoke            | 10 -----
 bonnie++-1.97.3/debian/tests/zcav_script      | 51 +++++++++++++++++++++++
 5 files changed, 153 insertions(+), 11 deletions(-)
 create mode 100644 bonnie++-1.97.3/debian/tests/bonnie++_script
 create mode 100644 bonnie++-1.97.3/debian/tests/getc_putc_script
 delete mode 100644 bonnie++-1.97.3/debian/tests/smoke
 create mode 100644 bonnie++-1.97.3/debian/tests/zcav_script

diff --git a/bonnie++-1.97.3/debian/tests/bonnie++_script b/bonnie++-1.97.3/debian/tests/bonnie++_script
new file mode 100644
index 0000000..1487995
--- /dev/null
+++ b/bonnie++-1.97.3/debian/tests/bonnie++_script
@@ -0,0 +1,59 @@
+#!/bin/sh
+
+set -e
+
+#Checking for autopkgtest dir, where tests script run on
+if [ -z "$ADTTMP" ]
+then
+        echo "Required envvar \"$ADTTMP\"is not set" >&2
+        exit 1
+fi
+
+cd $ADTTMP
+
+TMPDIR="$(mktemp -d)"
+TEST_SIZE=10G
+BONNIE_LOG=bonnie.log
+
+echo "====Start bonnie++===="
+
+echo "This part of test will take a while. Don't stop!"
+bonnie++ -d $TMPDIR -s $TEST_SIZE -n 0 -m TEST -f -b -u root > $BONNIE_LOG 2>&1
+
+rm -rf $TMPDIR
+rm -f $mktemp
+
+last_line_log_num=$(wc -l < $BONNIE_LOG)
+empty_line_num=`expr $last_line_log_num - 1`
+empty_line_num=$empty_line_num"p"
+empty_line=$(sed -n $empty_line_num $BONNIE_LOG)
+
+if [ -z $empty_line ]; then
+  echo "PASS"
+
+  last_line_num=$last_line_log_num"p"
+  last_line=$(sed -n $last_line_num $BONNIE_LOG)
+
+  echo "$last_line" | bon_csv2html > convert.html
+  echo "PASS"
+
+  echo "$last_line" | bon_csv2txt > convert.table
+  echo "PASS"
+else
+  exit 1
+fi
+
+RANSEED=10
+RANCOUNT=10
+OUTPUT_PREDICT="Generating $RANCOUNT random numbers with seed $RANSEED""."
+RANLOG_PARAM=auto_generate.log
+RANLOG=rand_generate.log
+
+generate_randfile -s $RANSEED -f $RANLOG_PARAM $RANCOUNT > $RANLOG 2>&1
+grep -q "$OUTPUT_PREDICT" $RANLOG
+
+echo "PASS"
+
+echo "====Done===="
+
+
diff --git a/bonnie++-1.97.3/debian/tests/control b/bonnie++-1.97.3/debian/tests/control
index 53d6267..5bc487a 100644
--- a/bonnie++-1.97.3/debian/tests/control
+++ b/bonnie++-1.97.3/debian/tests/control
@@ -1 +1,7 @@
-Tests: smoke
+Tests: bonnie++_script, getc_putc_script 
+Depends: @
+Restrictions: needs-root
+
+Tests: zcav_script
+Depends: @
+Restrictions: needs-root, allow-stderr
diff --git a/bonnie++-1.97.3/debian/tests/getc_putc_script b/bonnie++-1.97.3/debian/tests/getc_putc_script
new file mode 100644
index 0000000..e108424
--- /dev/null
+++ b/bonnie++-1.97.3/debian/tests/getc_putc_script
@@ -0,0 +1,36 @@
+#!/bin/sh
+
+set -e
+
+#Checking for autopkgtest dir, where tests script run on
+if [ -z "$ADTTMP" ]
+then
+        echo "Required envvar \"$ADTTMP\"is not set" >&2
+        exit 1
+fi
+
+cd $ADTTMP
+
+TMPDIR="$(mktemp -d)"
+TEST_SIZE=50
+TEST_PARAM_NAME=TEST
+TEST_USER=root
+TEST_GIT=0
+TEST_LOG=getc_putc.log
+
+echo "====Start getc_putc===="
+
+getc_putc -d $TMPDIR -s $TEST_SIZE -m $TEST_PARAM_NAME -u $TEST_USER -g $TEST_GIT > $TEST_LOG 2>&1
+
+rm -rf $TMPDIR
+rm -f $mktemp
+
+OUTPUT_PREDICT1="Extending file...done"
+OUTPUT_PREDICT2="Using uid:0, gid:$TEST_GIT""."
+
+grep -q "$OUTPUT_PREDICT1" $TEST_LOG
+grep -q "$OUTPUT_PREDICT2" $TEST_LOG
+
+echo "PASS"
+
+echo "====DONE===="
diff --git a/bonnie++-1.97.3/debian/tests/smoke b/bonnie++-1.97.3/debian/tests/smoke
deleted file mode 100644
index f9830f3..0000000
--- a/bonnie++-1.97.3/debian/tests/smoke
+++ /dev/null
@@ -1,10 +0,0 @@
-#!/bin/sh
-
-set -e
-
-tmpdir="$(mktemp -d)"
-trap "rm -rf $tmpdir" 0 INT QUIT ABRT PIPE TERM
-
-# A minimalist bonnie++ run
-/usr/sbin/bonnie++ -q -u $(id -u) -d "$tmpdir" -s 0 -n 1 > /dev/null; then
-exit $?
diff --git a/bonnie++-1.97.3/debian/tests/zcav_script b/bonnie++-1.97.3/debian/tests/zcav_script
new file mode 100644
index 0000000..13e91ef
--- /dev/null
+++ b/bonnie++-1.97.3/debian/tests/zcav_script
@@ -0,0 +1,51 @@
+#!/bin/sh
+
+set -e
+
+#Checking for autopkgtest dir, where tests script run on
+if [ -z "$ADTTMP" ]
+then
+        echo "Required envvar \"$ADTTMP\"is not set" >&2
+        exit 1
+fi
+
+cd $ADTTMP
+
+echo "====Start zcav===="
+
+IMG=test.img
+IMG_BS=1k
+IMG_COUNT=26384
+
+dd if=/dev/zero of=$IMG bs=$IMG_BS count=$IMG_COUNT
+
+DEVDIR=
+CONTAIN_DEV=/dev/loop
+LIST_LOOP=list_loop
+
+ls /dev/loop* > $LIST_LOOP 2>&1
+
+LOOP_SIZE=$(wc -l < $LIST_LOOP)
+
+if [ -s $LIST_LOOP ];
+then
+  if [ $LOOP_SIZE -eq 1 ];
+  then
+    DEVDIR=/dev/loop0
+  else
+    LOOP_SIZE=`expr $LOOP_SIZE - 1`
+    DEVDIR=$CONTAIN_DEV$LOOP_SIZE
+  fi
+else
+  DEVDIR=/dev/loop0
+fi
+
+losetup $DEVDIR $IMG
+
+zcav -b 1:1 $DEVDIR > zcav.log
+
+losetup -d $DEVDIR
+
+echo "PASS"
+
+echo "====Done===="
-- 
2.15.1

